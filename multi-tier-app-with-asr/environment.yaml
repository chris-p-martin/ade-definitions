schemaVersion: 1.0
name: Multi-Tier App Service with ASR
description: Deploy a highly available multi-tier application architecture with Web Apps and SQL Database, with optional Azure Site Recovery for disaster recovery failover to a secondary region.

parameters:
  - id: environment_name
    name: Environment Name
    description: Name for this environment (used for all resource naming)
    required: true
    type: string
    default: multiapp
    validation:
      pattern: ^[a-z0-9-]{1,20}$
      message: Must be lowercase alphanumeric and hyphens, max 20 characters

  - id: primary_location
    name: Primary Region
    description: Primary Azure region for active resources
    required: false
    type: string
    default: eastus
    allowed_values:
      - eastus
      - eastus2
      - westus
      - westus2
      - westus3
      - centralus
      - northeurope
      - westeurope
      - southeastasia
      - eastasia
      - japaneast

  - id: secondary_location
    name: Secondary Region
    description: Secondary region for ASR failover. Must be different from primary.
    required: false
    type: string
    default: westus
    allowed_values:
      - eastus
      - eastus2
      - westus
      - westus2
      - westus3
      - centralus
      - northeurope
      - westeurope
      - southeastasia
      - eastasia
      - japaneast

  - id: enable_asr
    name: Enable ASR
    description: Enable Azure Site Recovery for multi-region failover capability with automatic failover and disaster recovery.
    required: false
    type: boolean
    default: true

  - id: num_tiers
    name: Number of Tiers
    description: Application architecture tiers - 2 for web+app or 3 for web+app+data
    required: false
    type: int
    default: 3
    allowed_values:
      - 2
      - 3

  - id: num_instances_per_tier
    name: Instances per Tier
    description: Number of App Service instances per tier (1-5) for load balancing
    required: false
    type: int
    default: 2
    allowed_values:
      - 1
      - 2
      - 3
      - 4
      - 5

  - id: tier_sku_configs
    name: Tier SKU Configuration
    description: SQL and App Service tier configuration (Standard S1/S2 or Premium P1)
    required: false
    type: object
    default:
      tier1:
        tier: Standard
        size: S1
      tier2:
        tier: Standard
        size: S1
      tier3:
        tier: Standard
        size: S1

  - id: enable_app_insights
    name: Enable Application Insights
    description: Enable Azure Application Insights for performance monitoring and diagnostics
    required: false
    type: boolean
    default: true

  - id: db_admin_username
    name: Database Admin Username
    description: SQL Database administrator login name (1-128 characters, avoid reserved names like admin or sa)
    required: false
    type: string
    default: azadmin
    validation:
      pattern: ^[a-zA-Z_][a-zA-Z0-9_]{0,127}$
      message: Must start with letter or underscore, alphanumeric and underscores only

  - id: db_admin_password
    name: Database Admin Password
    description: SQL Database administrator password (12+ characters with uppercase, lowercase, and number)
    required: true
    type: secureString
    validation:
      pattern: ^(?=.*[A-Z])(?=.*[a-z])(?=.*\d).{8,}$
      message: Must be 8+ chars with uppercase, lowercase, and number
